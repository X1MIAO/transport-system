<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>云端货运管理系统</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
</head>
<body>
    <div class="container mt-4">
        <!-- 登录状态显示 -->
        <div id="authStatus" class="mb-4">
            <button class="btn btn-sm btn-outline-success" onclick="anonymousLogin()">快速登录</button>
            <span id="userInfo" class="ms-3"></span>
        </div>

        <!-- 原有表单保持不变 -->
        <form id="transportForm" class="mb-4">
            <!-- 原有表单字段保持不变 -->
        </form>

        <!-- 数据表格保持不变 -->
        <table class="table table-striped" id="dataTable">
            <!-- 原有表格结构保持不变 -->
        </table>
    </div>

<script>
// Firebase配置（替换为你自己的配置）
const firebaseConfig = {
  apiKey: "AIzaSyAPjz-W6ybOuvAA0gGuOk0_MCah58pFndI",
  authDomain: "xitong-f8eb4.firebaseapp.com",
  databaseURL: "https://xitong-f8eb4-default-rtdb.firebaseio.com",
  projectId: "xitong-f8eb4",
  storageBucket: "xitong-f8eb4.firebasestorage.app",
  messagingSenderId: "620239386766",
  appId: "1:620239386766:web:b50c35341bca80f3d131df",
  measurementId: "G-WC3PZPCJ5R"
};

// 初始化Firebase
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// 用户状态监听
auth.onAuthStateChanged(user => {
    if (user) {
        document.getElementById('userInfo').innerHTML = `
            已登录（匿名ID: ${user.uid.slice(0, 8)}）
            <button class="btn btn-sm btn-danger ms-2" onclick="logout()">退出</button>
        `;
        loadRealTimeData();
    } else {
        document.getElementById('userInfo').innerHTML = "未登录";
    }
});

// 匿名登录
async function anonymousLogin() {
    try {
        await auth.signInAnonymously();
    } catch (error) {
        alert("登录失败: " + error.message);
    }
}

// 退出登录
function logout() {
    auth.signOut();
}

// 实时数据加载
function loadRealTimeData() {
    const userId = auth.currentUser?.uid;
    if (!userId) return;

    db.collection("transports")
        .where("userId", "==", userId)
        .orderBy("timestamp", "desc")
        .onSnapshot(snapshot => {
            const records = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                // 转换Firebase Timestamp
                date: doc.data().date.toDate().toISOString().split('T')[0]
            }));
            updateTable(records);
        });
}

// 修改后的表单提交
document.getElementById('transportForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const user = auth.currentUser;
    if (!user) return alert("请先登录");

    // 获取表单数据
    const formData = {
        date: new Date(document.getElementById('date').value),
        plateNumber: document.getElementById('plateNumber').value,
        driver: document.getElementById('driver').value,
        cargo: document.getElementById('cargo').value,
        origin: document.getElementById('origin').value,
        destination: document.getElementById('destination').value,
        startTon: parseFloat(document.getElementById('startTon').value),
        endTon: parseFloat(document.getElementById('endTon').value),
        unitPrice: parseFloat(document.getElementById('unitPrice').value),
        costs: Array.from(document.querySelectorAll('.cost-item')).map(item => ({
            name: item.querySelector('.cost-name').value,
            amount: parseFloat(item.querySelector('.cost-amount').value)
        })),
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        userId: user.uid
    };

    // 计算字段
    formData.totalPrice = formData.endTon * formData.unitPrice;
    formData.totalCost = formData.costs.reduce((sum, c) => sum + c.amount, 0);
    formData.remaining = formData.totalPrice - formData.totalCost;

    try {
        await db.collection("transports").add(formData);
        document.getElementById('transportForm').reset();
    } catch (error) {
        console.error("保存失败:", error);
        alert("数据保存失败，请检查网络连接");
    }
});

// 修改后的Excel导出
async function exportToExcel() {
    const user = auth.currentUser;
    if (!user) return alert("请先登录");

    try {
        const snapshot = await db.collection("transports")
            .where("userId", "==", user.uid)
            .get();
            
        const records = snapshot.docs.map(doc => {
            const data = doc.data();
            return {
                日期: data.date.toDate().toLocaleDateString(),
                车牌号: data.plateNumber,
                司机: data.driver,
                货物名称: data.cargo,
                起运地: data.origin,
                到货地: data.destination,
                起运吨数: data.startTon,
                到运吨数: data.endTon,
                单价: data.unitPrice,
                总价: data.totalPrice,
                行车费用: data.costs.map(c => `${c.name}: ${c.amount}`).join('; '),
                费用剩余: data.remaining
            };
        });

        const ws = XLSX.utils.json_to_sheet(records);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "货运数据");
        XLSX.writeFile(wb, "货运数据.xlsx");
    } catch (error) {
        console.error("导出失败:", error);
        alert("导出数据失败，请重试");
    }
}

// 保持原有的updateTable函数和界面交互逻辑
function updateTable(records) {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = records.map(record => `
        <tr>
            <td>${record.date}</td>
            <td>${record.plateNumber}</td>
            <td>${record.driver}</td>
            <td>${record.cargo}</td>
            <td>${record.origin}</td>
            <td>${record.destination}</td>
            <td>${record.startTon.toFixed(2)}</td>
            <td>${record.endTon.toFixed(2)}</td>
            <td>${record.unitPrice.toFixed(2)}</td>
            <td>${record.totalPrice.toFixed(2)}</td>
            <td>${record.costs.map(c => `${c.name}: ${c.amount}`).join(', ')}</td>
            <td class="${record.remaining < 0 ? 'text-danger' : 'text-success'}">
                ${record.remaining.toFixed(2)}
            </td>
        </tr>
    `).join('');
}
</script>

<style>
/* 保持原有样式 */
.text-danger { color: #dc3545; }
.text-success { color: #28a745; }
.cost-item { margin-bottom: 5px; }
</style>
</body>
</html>